---
title: "eQTL genotype boxplots"
##output: html_notebook
---
```{r}
suppressMessages({
    library(data.table)
    library(BiocParallel)
    library(qs2)
    library(SummarizedExperiment)
    library(stringi)
    library(GenomicRanges)
    library(ggplot2)
    library(pgenlibr)
    library(here)
  })
here::i_am('.git/HEAD')
rdsdir=here("processed-data", "rds")
## refdata -> ref folder symlink to CHESS Brain ref data for now
refdir=here("processed-data", "ref")

ds2name <- setNames( c("SpD01-WMtz", "SpD02-L3/4", "SpD03-L6",  "SpD04-WM", "SpD05-L5",
       "SpD06-L2/3","SpD07-L1", "Neun", "Vasc", "PNN", "Neuropil"),  c(paste0('spd0',1:7), "neun", "vasc", "pnn", "neuropil"))
```

```{r load all independent tensor QTL results}
pat <- '\\.map_independent\\.txt\\.gz$'
fcis <- list.files(path='tqtl_out', pattern=pat, recursive = TRUE, full.names = TRUE)
names(fcis) <- sub("/", "", stri_match_first_regex(fcis, '/(\\w+)\\.gene')[,2])
indres <- lapply(fcis, fread)
```


```{r load genotypes}
pgen_prefix <- here("processed-data", "genotypes", "plink2", "merged_maf05")

#' Load and prepare genotype data from plink2 files
#' @param pgen_prefix Path prefix to plink2 files (without .pgen/.pvar/.psam extension)
#' @return List with: dosage (samples x variants matrix), labels (samples x variants character matrix),
#'         pvar (data.table with variant info), samples (character vector of sample IDs)
prepGenotypes <- function(pgen_prefix) {
  # File paths
  pgen_file <- paste0(pgen_prefix, ".pgen")
  pvar_file <- paste0(pgen_prefix, ".pvar")
  psam_file <- paste0(pgen_prefix, ".psam")
  # Check files exist
  stopifnot("pgen file not found" = file.exists(pgen_file))
  stopifnot("pvar file not found" = file.exists(pvar_file))
  stopifnot("psam file not found" = file.exists(psam_file))
  # Load pvar (variant info)
  pvar <- fread(pvar_file, sep = "\t")
  setnames(pvar, "#CHROM", "CHROM")
  pvar[, var_idx := .I]  # 1-based index
  # Load psam (sample info)
  psam <- fread(psam_file, sep = "\t")
  # psam typically has #IID column
  if ("#IID" %in% names(psam)) {
    samples <- psam[["#IID"]]
  } else if ("IID" %in% names(psam)) {
    samples <- psam[["IID"]]
  } else {
    stop("Cannot find sample ID column in psam file")
  }
  n_samples <- length(samples)
  n_variants <- nrow(pvar)
  message(sprintf("Loading %d variants x %d samples...", n_variants, n_samples))
  # Open pgen file
  pgen <- NewPgen(pgen_file)
  # Read all genotypes - ReadList returns samples x variants matrix
  # variant_subset uses 1-based indices
  dosage <- ReadList(pgen, seq_len(n_variants), meanimpute = FALSE)
  # Close pgen
  rm(pgen)
  gc()
  # Set row/col names
  rownames(dosage) <- samples
  colnames(dosage) <- pvar$ID
  # Pre-compute genotype labels (concatenated format: TT, TC, CC)
  message("Computing genotype labels...")
  labels <- matrix(NA_character_, nrow = n_samples, ncol = n_variants,
                   dimnames = list(samples, pvar$ID))
  for (i in seq_len(n_variants)) {
    ref <- pvar$REF[i]
    alt <- pvar$ALT[i]
    # Dosage: 0 = REF/REF, 1 = REF/ALT, 2 = ALT/ALT
    geno_vec <- round(dosage[, i])  # Round to nearest integer for labels
    labels[, i] <- c(
      paste0(ref, ref),  # 0
      paste0(ref, alt),  # 1
      paste0(alt, alt)   # 2
    )[geno_vec + 1L]
  }

  message("Done loading genotypes.")

  list(
    dosage = dosage,
    labels = labels,
    pvar = pvar,
    samples = samples
  )
}
# Load genotypes
geno <- prepGenotypes(pgen_prefix)
```


```{r test dataset}
## let's focus on 1 independent result for testing:
indr <- indres[[1]]
#      V1    phenotype_id num_var beta_shape1 beta_shape2  true_df pval_true_df         variant_id start_distance end_distance ma_samples ma_count         af pval_nominal     slope
#   <int>          <char>   <int>       <num>       <num>    <num>        <num>             <char>          <int>        <int>      <int>    <int>      <num>        <num>     <num>
#1:     0 ENSG00000159339    3839    1.048327    335.6378 25.93697 2.639593e-09  chr1:17346607:C:T          38411        38411         42       52 0.41269842 1.462546e-10  1.147336
#2:     1 ENSG00000218510    4438    1.057207    355.8546 25.37442 5.765979e-07  chr1:22020759:C:T          -3800        -3800         20       23 0.18253969 5.238598e-08  1.324606
#3:     2 ENSG00000117748    2292    1.027371    130.6743 25.78039 3.068787e-07  chr1:27914572:G:A           -175         -175          9        9 0.07142857 3.218513e-08  1.268317
#4:     3 ENSG00000134690    3810    1.038049    318.2303 26.00598 1.265930e-06  chr1:38579916:A:C         887434       887434          9        9 0.07142857 1.889060e-07 -1.860726
#5:     4 ENSG00000280670    3188    1.041969    122.6586 24.95545 4.113737e-07 chr1:46088315:AC:A         588235       588235         30       34 0.26984128 2.691792e-08  1.156558
#    slope_se  pval_perm    pval_beta  rank
#       <num>      <num>        <num> <int>
#1: 0.1206732 0.00009999 4.423238e-07     1
#2: 0.1840939 0.00039996 1.230865e-04     1
#3: 0.1719210 0.00009999 3.004143e-05     1
#4: 0.2768010 0.00009999 2.942595e-04     1
#5: 0.1553580 0.00009999 3.271190e-05     1

spe <- qs_read(file.path('tqtl_in', 'spd01.gene.spe.qs2'))
## use assays(spe)$tmm for expression data, TMM normalized log(CPM+1)

pvar <- fread(here("processed-data/genotypes/plink2", "merged_maf05.pvar"), sep = "\t")
setnames(pvar, '#CHROM', 'CHROM')
## plink pvar data (for REF/ALT clarification)
#    CHROM    POS              ID    REF    ALT
#   <char>  <int>          <char> <char> <char>
#1:   chr1 798969 chr1:798969:T:C      T      C
#2:   chr1 816376 chr1:816376:T:C      T      C
#3:   chr1 817341 chr1:817341:A:G      G      A
#4:   chr1 823913 chr1:823913:T:A      T      A
#5:   chr1 828811 chr1:828811:T:G      T      G
```


```{r prep_eQTLPlotData}
#' Prepare eQTL plot data by residualizing expression against covariates
#' @param spe SpatialExperiment object with tmm assay
#' @param geno Genotype object from prepGenotypes()
#' @param covar_file Path to tensorQTL covariates file
#' @return List with residualized/raw expression matrices, gene/sample info, and genotype reference
prep_eQTLPlotData <- function(spe, geno, covar_file) {

  # ---- Validate inputs ----
  stopifnot("spe must be a SummarizedExperiment" = is(spe, "SummarizedExperiment"))
  stopifnot("geno must be a list with dosage, labels, pvar, samples" =
              all(c("dosage", "labels", "pvar", "samples") %in% names(geno)))
  stopifnot("covar_file must exist" = file.exists(covar_file))
  stopifnot("spe must have 'tmm' assay" = "tmm" %in% assayNames(spe))

  # ---- Load covariates ----
  message("Loading covariates from: ", covar_file)
  covars_raw <- fread(covar_file, sep = "\t")
  covar_names <- covars_raw$id
  covar_samples <- setdiff(names(covars_raw), "id")

  # Transpose: samples as rows, covariates as columns
  covar_mat <- t(as.matrix(covars_raw[, -1, with = FALSE]))
  colnames(covar_mat) <- covar_names
  rownames(covar_mat) <- covar_samples

  # Remove intercept if present (cleaningY doesn't need it)
  if ("(Intercept)" %in% colnames(covar_mat)) {
    covar_mat <- covar_mat[, colnames(covar_mat) != "(Intercept)", drop = FALSE]
  }

  # ---- Align samples across all sources ----
  spe_samples <- colnames(spe)
  geno_samples <- geno$samples

  message(sprintf("Sample counts: SPE=%d, Genotypes=%d, Covariates=%d",
                  length(spe_samples), length(geno_samples), length(covar_samples)))

  # Find common samples
  common_samples <- Reduce(intersect, list(spe_samples, geno_samples, covar_samples))

  if (length(common_samples) == 0) {
    stop("No common samples found across SPE, genotypes, and covariates!")
  }

  n_dropped <- length(spe_samples) - length(common_samples)
  if (n_dropped > 0) {
    warning(sprintf("Dropped %d samples not present in all data sources. Using %d samples.",
                    n_dropped, length(common_samples)))
  }
  message(sprintf("Using %d common samples", length(common_samples)))

  # Reorder all data to common sample order
  spe_idx <- match(common_samples, spe_samples)
  geno_idx <- match(common_samples, geno_samples)
  covar_idx <- match(common_samples, covar_samples)

  # Subset and reorder covariate matrix
  covar_mat <- covar_mat[covar_idx, , drop = FALSE]

  # ---- Extract expression data ----
  message("Extracting expression data...")
  raw_expr <- assays(spe)$tmm[, spe_idx, drop = FALSE]
  colnames(raw_expr) <- common_samples

  # ---- Residualize expression ----
  # cleaningY: P = number of columns to PROTECT (keep) from left of model matrix
  # We want to regress out all covariates to show pure genotype effect
  # P=0 means regress out everything; but cleaningY needs at least the intercept
  # Since we removed intercept, we need to add it back for cleaningY to work properly
  message("Residualizing expression with jaffelab::cleaningY...")

  # Add intercept column as first column (cleaningY needs it)
  mod_mat <- cbind("(Intercept)" = 1, covar_mat)

  # P=1 protects only intercept, regresses out all other covariates
  resid_expr <- jaffelab::cleaningY(raw_expr, mod = mod_mat, P = 1)
  colnames(resid_expr) <- common_samples

  # ---- Build gene info ----
  rr <- rowRanges(spe)
  gene_info <- data.table(
    gene_id = rownames(spe),
    gene_name = rr$gene_name,
    chr = as.character(seqnames(rr)),
    start = start(rr),
    end = end(rr)
  )

  # ---- Build sample info ----
  cd <- colData(spe)[spe_idx, ]
  sample_info <- data.table(
    sample_id = common_samples,
    DX = cd$DX
  )
  # Add any other useful columns if present
  if ("sex" %in% names(cd)) sample_info[, sex := cd$sex]
  if ("age" %in% names(cd)) sample_info[, age := cd$age]

  # ---- Store sample indices for genotype subsetting ----
  message("Done preparing eQTL plot data.")

  list(
    resid_expr = resid_expr,
    raw_expr = raw_expr,
    gene_info = gene_info,
    sample_info = sample_info,
    sample_idx = geno_idx,  # indices into geno$dosage/labels rows
    geno = geno  # reference to genotype object
  )
}

# ---- Test with loaded objects ----
# Load neun spe to match the neun eQTL results (indr is from neun)
spe <- qs_read(file.path('tqtl_in', 'neun.gene.spe.qs2'))
covar_file <- file.path("tqtl_in", "neun.gene.covars.txt")

# Run prep function
plotdata <- prep_eQTLPlotData(spe, geno, covar_file)
```

```{r test prep_eQTLPlotData}
# Verify output structure
cat("\n=== prep_eQTLPlotData output ===\n")
cat("resid_expr:", class(plotdata$resid_expr), "dim:", paste(dim(plotdata$resid_expr), collapse=" x "), "\n")
cat("raw_expr:", class(plotdata$raw_expr), "dim:", paste(dim(plotdata$raw_expr), collapse=" x "), "\n")
cat("gene_info:", class(plotdata$gene_info), "nrow:", nrow(plotdata$gene_info), "\n")
cat("sample_info:", class(plotdata$sample_info), "nrow:", nrow(plotdata$sample_info), "\n")
cat("DX distribution:", table(plotdata$sample_info$DX), "\n")

# Test genotype retrieval for an eQTL pair
cat("\n=== Genotype retrieval test ===\n")
test_var <- indr$variant_id[1]
test_gene <- indr$phenotype_id[1]
cat("Test variant:", test_var, "\nTest gene:", test_gene, "\n")

geno_labels <- plotdata$geno$labels[plotdata$sample_idx, test_var]
expr_resid <- plotdata$resid_expr[test_gene, ]

cat("\nExpression by genotype (residualized):\n")
for (g in sort(unique(geno_labels))) {
  vals <- expr_resid[geno_labels == g]
  cat(sprintf("  %s (n=%d): mean=%.3f, sd=%.3f\n", g, length(vals), mean(vals), sd(vals)))
}
cat("\nExpected beta from eQTL:", round(indr$slope[1], 3), "\n")
```


```{r plot_eQTL_boxplots}
#' Create faceted boxplots for eQTL gene-variant pairs
#' @param plotdata Prepared data from prep_eQTLPlotData()
#' @param eqtl_pairs data.table/data.frame with columns: phenotype_id, variant_id,
#'        and optionally: slope (beta), pval_nominal, gene_name
#' @param use_raw Logical; if TRUE use raw expression, otherwise use residualized (default FALSE)
#' @param title Optional plot title
#' @return ggplot object
plot_eQTL_boxplots <- function(plotdata, eqtl_pairs, use_raw = FALSE, title = NULL) {
  # ---- Validate inputs ----
  required_cols <- c("phenotype_id", "variant_id")
  stopifnot("eqtl_pairs must have phenotype_id and variant_id columns" =
              all(required_cols %in% names(eqtl_pairs)))
  # Ensure data.table
  if (!is.data.table(eqtl_pairs)) eqtl_pairs <- as.data.table(eqtl_pairs)
  n_pairs <- nrow(eqtl_pairs)
  if (n_pairs == 0) stop("No eQTL pairs provided")
  # ---- Check variants exist in genotype data ----
  missing_vars <- setdiff(eqtl_pairs$variant_id, colnames(plotdata$geno$dosage))
  if (length(missing_vars) > 0) {
    warning(sprintf("Skipping %d variants not found in genotype data: %s",
                    length(missing_vars), paste(head(missing_vars, 3), collapse=", ")))
    eqtl_pairs <- eqtl_pairs[!variant_id %in% missing_vars]
  }
  # ---- Check genes exist in expression data ----
  missing_genes <- setdiff(eqtl_pairs$phenotype_id, rownames(plotdata$resid_expr))
  if (length(missing_genes) > 0) {
    warning(sprintf("Skipping %d genes not found in expression data: %s",
                    length(missing_genes), paste(head(missing_genes, 3), collapse=", ")))
    eqtl_pairs <- eqtl_pairs[!phenotype_id %in% missing_genes]
  }
  if (nrow(eqtl_pairs) == 0) stop("No valid eQTL pairs remain after filtering")
  # ---- Add gene names if not present ----
  if (!"gene_name" %in% names(eqtl_pairs)) {
    gene_map <- plotdata$gene_info[, .(gene_id, gene_name)]
    eqtl_pairs <- merge(eqtl_pairs, gene_map, by.x = "phenotype_id", by.y = "gene_id", all.x = TRUE)
    eqtl_pairs[is.na(gene_name), gene_name := phenotype_id]
  }
  # ---- Build plot data ----
  expr_mat <- if (use_raw) plotdata$raw_expr else plotdata$resid_expr
  sample_info <- plotdata$sample_info
  sample_idx <- plotdata$sample_idx
  # Collect data for all pairs
  plot_list <- lapply(seq_len(nrow(eqtl_pairs)), function(i) {
    gene_id <- eqtl_pairs$phenotype_id[i]
    var_id <- eqtl_pairs$variant_id[i]
    gene_name <- eqtl_pairs$gene_name[i]
    # Get expression and genotypes
    expr_vals <- expr_mat[gene_id, ]
    geno_labels <- plotdata$geno$labels[sample_idx, var_id]
    geno_dosage <- plotdata$geno$dosage[sample_idx, var_id]
    # Order genotypes by dosage within this variant
    geno_order <- unique(geno_labels[order(geno_dosage)])
    # Build facet label
    facet_label <- sprintf("%s\n%s", var_id, gene_name)
    # Get beta and p-value if available
    beta_val <- if ("slope" %in% names(eqtl_pairs)) eqtl_pairs$slope[i] else NA
    pval_val <- if ("pval_nominal" %in% names(eqtl_pairs)) eqtl_pairs$pval_nominal[i] else NA
    data.table(
      sample_id = names(expr_vals),
      expression = as.numeric(expr_vals),
      genotype = factor(geno_labels, levels = geno_order),  # Factor per-variant
      dosage = geno_dosage,
      DX = sample_info$DX,
      gene_id = gene_id,
      gene_name = gene_name,
      variant_id = var_id,
      facet = facet_label,
      beta = beta_val,
      pval = pval_val
    )
  })
  plot_dt <- rbindlist(plot_list)
  # ---- Create annotation labels for each facet ----
  annot_dt <- plot_dt[, .(
    beta = unique(beta),
    pval = unique(pval),
    ymin = min(expression),
    n_geno = length(unique(genotype))
  ), by = facet]
  annot_dt[, label := sprintf("beta = %.3g\np = %.2e", beta, pval)]
  # Position at rightmost genotype (x) and bottom of facet (y)
  annot_dt[, x := n_geno]
  annot_dt[, y := ymin]
  # ---- Build plot ----
  p <- ggplot(plot_dt, aes(x = genotype, y = expression)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.5) +
    geom_jitter(aes(color = DX), width = 0.2, size = 2, alpha = 0.8) +
    facet_wrap(~ facet, scales = "free") +
    scale_color_manual(values = c("NTC" = "#1b9e77", "SCZ" = "#d95f02")) +
    scale_x_discrete(drop = TRUE) +
    labs(
      x = "Genotype",
      y = ifelse(use_raw, "Expression (TMM log2 CPM)", "Residualized Expression"),
      color = "Diagnosis"
    ) +
    theme_bw() +
    theme(
      strip.text = element_text(size = 9),
      legend.position = "bottom"
    )

  # Add beta/p-value annotations
  if (all(!is.na(annot_dt$beta))) {
    p <- p + geom_text(data = annot_dt,
                       aes(x = x, y = y, label = label),
                       hjust = 1, vjust = 0, size = 3, inherit.aes = FALSE)
  }
  if (!is.null(title)) {
    p <- p + ggtitle(title)
  }
  p
}

# ---- Test with neun data ----
# Find 3 eQTLs with high significance and large effect size
indr_neun <- indres[["neun"]]
indr_neun[, abs_slope := abs(slope)]

# Filter for high significance and effect, ensure 3 genotype classes visible (reasonable MAF)
top_eqtls <- indr_neun[pval_nominal < 1e-8 & abs_slope > 1.0 & af > 0.15 & af < 0.85][order(-abs_slope)][1:3]
cat("Selected eQTLs for plotting:\n")
top_eqtls[, .(phenotype_id, variant_id, slope, pval_nominal, af)]

# Create plot
p <- plot_eQTL_boxplots(plotdata, top_eqtls, title = "Top neun eQTLs")
p
```