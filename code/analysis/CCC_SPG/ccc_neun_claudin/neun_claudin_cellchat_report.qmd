---
title: "Differential cell-cell communication between SCZ and NTC using cellchat V2"
format:
  pdf:
    toc: true
execute:
  echo: false
---

# Method

We are using differential cell-cell communication analysis (implemented via cell chat V2) to investigate some cell-cell communication pattern between neurons and vasculatures implicated in .

Specifically, we have subset the  data to spots that are either NeuN+ or claudin+. There exists double positive spots, i.e. spots that are both NeuN+ and Claudin+. These spots are removed from the analysis. Please refer to `EDA.R` for details on what spots being included or not.

> Note: The code generating this report doesn't including running cell chat V2 pipeline. Please refer to `cell_cell_comm_prep.R` to run the cell chat pipeline first.


# Boyi's TL;DR
- There are fewer communication pattern among NTC samples compared to SCZ samples
- Most differential communication happens in Neuron-Neuron communication. Specifically, there are more Neuron-Neuron communication among SCZ samples.
- Some important pathways seems to be: `Glutamate` and `PTN` enriched in NTC samples, and `PSAP` and `GABA-A` and `GABA-B` enriched in SCZ samples.



# Results
```{r load_library, echo = FALSE}
suppressPackageStartupMessages({
  library(here)
  library(CellChat)
  library(tidyverse)
  library(patchwork)
})
```

```{r load_merged_cell_chat, echo = FALSE}
cellchat <- readRDS(
  here(
    "processed-data/rds/spg_ccc",
    "neun_claudin_merged_cellchat.rds"
  )
)
```


## Number of interaction and interaction strength
### Overall levelfor SCZ and NTC respectively
- **\# of interaction
There's fewer neuron-to-vasculature interaction among NTC group compared to SCZ group.**
- The strength between the two groups seems to be equaly strong.  
```{r}
gg1 <- compareInteractions(cellchat, show.legend = F, group = c(1, 2))
gg2 <- compareInteractions(cellchat, show.legend = F, group = c(1, 2), measure = "weight")
gg1 + gg2
```

### Communication pattern between Neun+ and Claudin+ spots

- **Increased (red) signaling in SCZ group, (in reference to NTC group) - many LR pair is enriched in neuron-neuron communication**
- Decreased (blue) signaling in SCZ grup, (in reference to NTC group) - there's limited number of differential communication among claudin-claudin.

> NOTE: The differential number of interactions or interaction strength in the cell-cell communication network between two datasets can be visualized using circle plot, where red (or blue) colored edges represent increased (or decreased) signaling in the second dataset compared to the first one. In our data anlysis, the first data set is **NTC** and the second data set is **SCZ**.


```{r}
gg1 <- netVisual_heatmap(cellchat)
#> Do heatmap based on a merged object
gg2 <- netVisual_heatmap(cellchat, measure = "weight")
#> Do heatmap based on a merged object
gg1 + gg2
```

Similarly, we can visualize in a chord diagram.
```{r}
par(mfrow = c(1,2), xpd=TRUE)
netVisual_diffInteraction(cellchat, weight.scale = T)
netVisual_diffInteraction(cellchat, weight.scale = T, measure = "weight")
```



# Compare major sources and targets - Not very informative
This visualization is not that informative.

```{r}

ntc_cellchat <- readRDS(here(
  "processed-data/rds/spg_ccc",
  "neun_claudin_ntc_cellchat.rds"
))
scz_cellchat <- readRDS(
  here(
    "processed-data/rds/spg_ccc",
    "neun_claudin_scz_cellchat.rds"
  )
)

object.list <- list(ntc = ntc_cellchat, scz = scz_cellchat)

num.link <- sapply(object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets
gg <- list()
for (i in 1:length(object.list)) {
  gg[[i]] <- object.list[[i]] |> 
  #netAnalysis_computeCentrality(slot.name = "netP") |>
   netAnalysis_signalingRole_scatter(title = names(object.list)[i], weight.MinMax = weight.MinMax)
}
#> Signaling role analysis on the aggregated cell-cell communication network from all signaling pathways
#> Signaling role analysis on the aggregated cell-cell communication network from all signaling pathways
patchwork::wrap_plots(plots = gg)
```

# differential signaling Pathway in Neun+ spots 
```{r}
gg1 <- netAnalysis_signalingChanges_scatter(cellchat, idents.use = "neun")
gg1
```
```{r}
gg1$data
```



## overall information flow of each signaling pathway or ligand-receptor pair
This visualization suggests that there's enriched `PSAP`-realted communication among NeuN+ spots among SCZ samples.
```{r}
# gg1 <- rankNet(cellchat, mode = "comparison", measure = "weight", sources.use = NULL, targets.use = NULL, stacked = T, do.stat = TRUE)
gg2 <- rankNet(cellchat, mode = "comparison", measure = "weight", sources.use = NULL, targets.use = NULL, stacked = F, do.stat = TRUE)

# gg1 + gg2
gg2
```

## Overall
```{r, fig.width=8}
library(ComplexHeatmap)
i = 1
pathway.union <- union(object.list[[i]]@netP$pathways, object.list[[i+1]]@netP$pathways)
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "all", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6)
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "all", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
```

## Outgoing
```{r, fig.width=8}
library(ComplexHeatmap)
i = 1
pathway.union <- union(object.list[[i]]@netP$pathways, object.list[[i+1]]@netP$pathways)
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6)
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "outgoing", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
```

## Incoming
```{r, fig.width=8}
library(ComplexHeatmap)
i = 1
pathway.union <- union(object.list[[i]]@netP$pathways, object.list[[i+1]]@netP$pathways)
ht1 = netAnalysis_signalingRole_heatmap(object.list[[i]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i], width = 5, height = 6)
ht2 = netAnalysis_signalingRole_heatmap(object.list[[i+1]], pattern = "incoming", signaling = pathway.union, title = names(object.list)[i+1], width = 5, height = 6)
draw(ht1 + ht2, ht_gap = unit(0.5, "cm"))
```




# Upregulated and downregulated signaling LR pairs

## Overall

### Increased signaling in SCZ
```{r, fig.width=8, fig.height=15}
netVisual_bubble(cellchat, comparison = c(1, 2), angle.x = 45,
title.name = "Increased signaling in SCZ",
max.dataset = 2,
remove.isolate = TRUE)
```

### Decreased signaling in SCZ
```{r, fig.width=8, fig.height=15}
netVisual_bubble(cellchat,   comparison = c(1, 2), angle.x = 45,
title.name = "Decreased signaling in SCZ",
max.dataset = 1,
remove.isolate = TRUE)
```

## Self-communication among NeuN+
### Increased signaling in SCZ
```{r, fig.width=8, fig.height=15}
netVisual_bubble(cellchat, sources.use = "neun", targets.use = "neun", 
comparison = c(1, 2), angle.x = 45,
title.name = "Increased signaling in SCZ",
max.dataset = 2,
remove.isolate = TRUE
)
```

### Decreased signaling in SCZ
```{r, fig.width=8, fig.height=15}
netVisual_bubble(cellchat, targets.use = "neun", sources.use = "neun",
comparison = c(1, 2), angle.x = 45,
title.name = "Decreased signaling in SCZ",
max.dataset = 1,
remove.isolate = TRUE)
```

