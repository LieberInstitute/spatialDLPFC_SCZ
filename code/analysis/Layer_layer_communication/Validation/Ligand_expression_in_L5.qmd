---
title: "Ligand expression in L5 to validate martinotti cell projection"
format: pdf
execute:
  echo: false
---

The objective of this report is to follow up on the cellchat validation. Specifically, we are interested in detecting if the detected L5-L1 communciation patterns is localized in Layer 5.

The rough implemetation is that 
- we'll use some marker genes (detected/defined in external study using mouse data) to call  martinotti cell in Layer 5 (SpD 05)
- Compare the gene expression of the ligands between martinotti cells and non martinotti cells

```{r}
suppressPackageStartupMessages({
  library(SpatialExperiment)
  library(here)
  library(tidyverse)
  library(ggbeeswarm)
  library(escheR)
  library(sessioninfo)
})
# Load Data ----
## Load Spe Object that has spatial domain label ----
spe <- readRDS(
  here(
    "processed-data/rds/spatial_cluster",
    "PRECAST",
    "spe_wo_spg_N63_PRECAST.rds"
  )
)

PRECAST_df_final <- readRDS(
  here(
    "processed-data/rds/spatial_cluster",
    "PRECAST",
    "test_clus_label_df_semi_inform_k_2-16.rds"
  )
)

col_data_df <- PRECAST_df_final |>
  right_join(
    colData(spe) |> data.frame(),
    by = c("key"),
    relationship = "one-to-one"
  )

rownames(col_data_df) <- colnames(spe)
colData(spe) <- DataFrame(col_data_df)

## Subset to NTC -----
spe <- spe[, spe$dx == "ntc"]
```

# Call Martinotti cells in layer 5
First thing we do is to see if we can identify a way to idenitfy Martinotti cells without validation. We have load and subset `spe` object to only contain NTC samples in an variable called `spe`.

Note:
 As this part of the analysis is not that important, we would not use any fancy tools to do this analysis. If intented, one can use unsupervised clustering only including some Martinotti cells as features or label transfering which would require external dataset.

## Define ways to call Martinotti cells
For the convinience of making visualization, we use a random sample in the dataset to do this part of explorative analysis.
```{r}
sub_spe <- spe[, spe$sample_id == spe$sample_id[1]]
```

First thing we do is to see the bivariate distribution of some marker genes of Marinotti cells, including `SST`, `RELN`, `PANTR1`.

With the preliminary analysis, Boyi chose a fairly naive threshold, either logcounts(`RELN`) > 0 or logcounts (`PANTR1`)>0 to call Martinotti cells (shown red in the following pairwise scatter plot).
```{r, fig.height = 8}
logcounts_df <- data.frame(
  SST = logcounts(sub_spe)[which(rowData(sub_spe)$gene_name == "SST"), sub_spe$PRECAST_07 == "spd05"],
  PANTR1 = logcounts(sub_spe)[which(rowData(sub_spe)$gene_name == "PANTR1"), sub_spe$PRECAST_07 == "spd05" ],
  RELN = logcounts(sub_spe)[which(rowData(sub_spe)$gene_name == "RELN"), sub_spe$PRECAST_07 == "spd05" ]
) |>
mutate(
  martinotti = (RELN > 0 | PANTR1 > 0)
)

pairs(logcounts_df[, 1:3],lower.panel=NULL , pch = 19,
col = c("black","red")[ as.numeric(logcounts_df$martinotti)+1])
```
 NOTE:
 Here, Boyi could also define that martinotti spots has to have SST expression. 

Here is the spot plot for showing the martinotti spots in Layer 5.
```{r}
sub_spe$martinotti <- {
  (logcounts(sub_spe)[which(rowData(sub_spe)$gene_name == "RELN"),] > 0 |
  logcounts(sub_spe)[which(rowData(sub_spe)$gene_name == "PANTR1"),] >0) &
  sub_spe$PRECAST_07 == "spd05"
}
sub_spe |> 
make_escheR() |>
add_ground("PRECAST_07") |>
add_symbol("martinotti", size = 0.6) +
scale_shape_manual(
      breaks = c("FALSE", "TRUE"),
      values = c(NA, 3),
      limits = c("TRUE")
)
```

# Viz Ligand Gene Expression for Martinotti+ spots vs Martinotti- spots

The ligand genes from the previous cellchat_NTC validation bubble plot include `GAD1/2`, `SLC6A1/8`. so what we are gonna do here is to viz gene expression of these ligand genes among only Layer 5 spots of all NTC samples and grouped by martinotti+ status. 

```{r}
ligand_df <- data.frame(
  PANTR1 = logcounts(spe)[which(rowData(spe)$gene_name == "PANTR1"), spe$PRECAST_07 == "spd05" ],
  RELN = logcounts(spe)[which(rowData(spe)$gene_name == "RELN"), spe$PRECAST_07 == "spd05" ],
  GAD1 = logcounts(spe)[which(rowData(spe)$gene_name == "GAD1"), spe$PRECAST_07 == "spd05"],
  GAD2 = logcounts(spe)[which(rowData(spe)$gene_name == "GAD2"), spe$PRECAST_07 == "spd05" ],
  SLC6A1 = logcounts(spe)[which(rowData(spe)$gene_name == "SLC6A1"), spe$PRECAST_07 == "spd05" ],
  SLC6A8 = logcounts(spe)[which(rowData(spe)$gene_name == "SLC6A8"), spe$PRECAST_07 == "spd05" ],
  sample_id = spe$sample_id [spe$PRECAST_07 == "spd05"]
) |>
mutate(
  martinotti = (RELN > 0 | PANTR1 > 0)
) |> select(-c(PANTR1, RELN))

ligand_df |> pivot_longer(
cols = c(GAD1, GAD2, SLC6A1, SLC6A8),
names_to = "ligand"
) |>
ggplot() +
geom_boxplot(aes(x = martinotti, y = value))+
facet_wrap(vars(ligand), scale = "free_y") +
ylab("log2counts") +
labs(title = "all L5 spots from all NTC ample")
```

Another way to visulize this is to calcualte the median value of all martinotti+/- spots for each individual.
```{r}
ligand_df |> pivot_longer(
cols = c(GAD1, GAD2, SLC6A1, SLC6A8),
names_to = "ligand"
) |>
group_by(ligand, sample_id, martinotti) |> 
summarize(value = median(value)) |> 
ggplot() +
geom_boxplot(aes(x = martinotti, y = value))+
facet_wrap(vars(ligand)) +
ylab("Median log2counts") +
labs("Median value from all NTC sample")
```
