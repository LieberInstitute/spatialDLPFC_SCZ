# Load library ----
suppressPackageStartupMessages({
  library(here)
  library(UpSetR)
  library(limma)
  library(tidyverse)
})



# Layer-specific Differential Expressed Genes ----
## Load interaction model ----
fit <- readRDS(
  here(
    "processed-data/PB_dx_genes",
    "test_inter_PRECAST_07_20240627.rds"
  )
)

## Create Contrast Matrix ----
cont.mat <- rbind(
  rep(-1, 7),
  rep(1, 7),
  matrix(0, nrow = 23, ncol = 7),
  cbind(rep(0, 6), diag(nrow = 6, ncol = 6))
)

colnames(cont.mat) <- sprintf("spd%02d", 1:7)

contrast_fit <- contrasts.fit(fit, cont.mat)
contrast_fit <- eBayes(contrast_fit)

## Iterate over each spatial domain ----
layer_test_res_df <- colnames(cont.mat) |>
  map_dfr(.f = function(spd_it) {
    spd_cont_df <- topTable(contrast_fit, coef = spd_it, num = Inf) |>
      mutate(spd = spd_it) |>
      rownames_to_column("gene_id")
    return(spd_cont_df)
  })



# Define DEGs ----

## NOTE: Create a list where the name of each element is spd, the element is a vector containing layer specific DEG

adj.threshold <- 0.10

listInput <- layer_test_res_df |>
  filter(adj.P.Val <= adj.threshold) |>
  group_by(spd) |>
  summarize(values = list(gene_id)) |>
  deframe()


## Create Readable SpD Names ----
spd_anno_df <- read_csv(
  here(
    "processed-data/man_anno",
    "spd_labels_k7.csv"
  )
) |>
  mutate(anno_lab = paste0(label, " (", spd, ") "))

names(listInput) <- spd_anno_df$anno_lab[match(names(listInput), spd_anno_df$spd)]


# TODO: translate SpD name to layer name


# Create Upset plot ----
pdf(
  here(
    "plots/PB_dx_genes",
    sprintf(
      "Upset_plot_layer_vulnerability_%02d.pdf",
      adj.threshold * 100
    )
  ),
  height = 5
)

upset(
  fromList(listInput[names(listInput) |> order()]),
  nintersects = NA,
  keep.order = T
)

dev.off()
# Session Info ----
