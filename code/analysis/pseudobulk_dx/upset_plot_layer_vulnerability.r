# Load library ----
suppressPackageStartupMessages({
  library(here)
  library(UpSetR)
  library(limma)
  library(tidyverse)
})

# Load Data ----
## Dx DEG genes ----
gene_df <- read_csv(
  here(
    "processed-data/PB_dx_genes/",
    "test_PRECAST_07.csv"
  )
)

adj_p_cutoff <- 0.10
sig_gene_df <- gene_df |>
  filter(fdr_ntc <= adj_p_cutoff)

## Layer Enrichment Data ----
raw_enrich_res <- readRDS(
  here(
    "processed-data", "rds", "layer_enrich_test",
    "test_enrich_PRECAST_07.rds"
  )
)

enrich_res <- raw_enrich_res |> filter(ensembl %in% sig_gene_df$ensembl)
spd_names <- sprintf("spd%02d", seq.int(1:7))

## Load Spatial domain annotation ----
spd_anno_df <- read_csv(
  here(
    "processed-data/man_anno",
    "spd_labels_k7.csv"
  )
) |>
  mutate(anno_lab = paste0(label, " (", spd, ") "))



# Per domain: find enriched and depleted genes ---
tmp <- spd_names |>
  set_names() |>
  map(.f = function(.spd) {
    # browser()
    ## Find signficant genes
    spd_gene_df <- enrich_res[
      enrich_res[[paste0("fdr_", .spd)]] <= 0.05,
    ]

    ## Separate to enriched/depleted
    list(
      spd = .spd,
      enrich_genes = spd_gene_df$ensembl[
        spd_gene_df[[paste0("logFC_", .spd)]] > 0
      ],
      deplete_genes = spd_gene_df$ensembl[
        spd_gene_df[[paste0("logFC_", .spd)]] < 0
      ]
    )
  })

## Create to list ----
## Enriched gene per spd ----
enrich_list <- tmp |>
  map(\(x) x$enrich_genes)

# reorder based on cortical layer order
names(enrich_list) <- spd_anno_df$anno_lab[match(names(enrich_list), spd_anno_df$spd)]
enrich_list <- enrich_list[sort(names(enrich_list))]

deplete_list <- tmp |>
  map(\(x) x$deplete_genes)

names(deplete_list) <- spd_anno_df$anno_lab[match(names(deplete_list), spd_anno_df$spd)]
deplete_list <- deplete_list[sort(names(deplete_list))]

# Upset plots ----
pdf(
  here(
    "plots/layer_vulnerability",
    "upset_plot_layer.pdf"
  )
)
## Enriched genes
upset(
  fromList(enrich_list),
  nsets = 7,
  sets = sort(
    names(enrich_list),
    decreasing = TRUE
  ),
  keep.order = TRUE,
  nintersects = NA,
  order.by = c("freq"),
  # main.bar.color = "blue",
  # sets.bar.color = "red",
  mainbar.y.label = "Enriched Genes",
  sets.x.label = "Spatial Domains"
)
## Depleted genes
upset(
  fromList(deplete_list),
  nsets = 7,
  sets = sort(
    names(enrich_list),
    decreasing = TRUE
  ),
  keep.order = TRUE,
  nintersects = NA,
  order.by = c("freq"),
  # main.bar.color = "blue",
  # sets.bar.color = "red",
  mainbar.y.label = "Depleted Genes",
  sets.x.label = "Spatial Domains"
)
dev.off()


# Output gene overlapping by spatial domains----
## Enriched genes
data.frame(
  ensembl = unique(unlist(enrich_list)),
  fromList(enrich_list)
) |>
  left_join(
    enrich_res |>
      select(ensembl, gene)
  ) |>
  write_csv(
    here(
      "processed-data", "layer_vulnerability",
      "enriched_genes.csv"
    )
  )


## Depleted genes
data.frame(
  ensembl = unique(unlist(deplete_list)),
  fromList(deplete_list)
) |>
  left_join(
    enrich_res |>
      select(ensembl, gene)
  ) |>
  write_csv(
    here(
      "processed-data", "layer_vulnerability",
      "deplete_genes.csv"
    )
  )

# Session Info ----
sessioninfo::session_info()
